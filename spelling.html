<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>5Aè‹±è¯­ï¼šå¬å†™ç‹è€… V51 - ç‰ˆæƒå½’lukaæ‰€æœ‰</title>
    <style>
        :root { --primary: #2196F3; --correct: #4CAF50; --wrong: #F44336; --warning: #FF9800; --bg: #e1f5fe; --lvl1: #4caf50; --lvl2: #ff9800; --lvl3: #9c27b0; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; overflow-x: hidden; padding-bottom: 80px; }
        .eye-care { background: #fffde7; color: #856404; width: 100%; text-align: center; padding: 8px 0; font-size: 0.75rem; border-bottom: 1px solid #ffeeba; font-weight: bold; position: sticky; top:0; z-index: 1001; }
        header { background: var(--primary); color: white; width: 100%; text-align: center; padding: 12px 0; font-weight: bold; position: sticky; top:33px; z-index: 1000; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        
        .progress-box { width: 94%; background: #fff; padding: 15px; border-radius: 15px; margin: 10px 0; box-shadow: 0 4px 10px rgba(0,0,0,0.05); box-sizing: border-box;}
        .p-row { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; font-size: 0.7rem; font-weight: bold; }
        .p-bar-bg { flex: 1; background: #eee; height: 10px; border-radius: 5px; overflow: hidden; }
        .p-fill { height: 100%; width: 0%; transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1); }
        
        #menu-screen { padding: 10px; width: 100%; max-width: 600px; box-sizing: border-box; }
        .lvl-selector { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 15px; }
        .lvl-btn { background: #fff; border: 2px solid #b3e5fc; padding: 12px 5px; border-radius: 12px; cursor: pointer; font-size: 0.8rem; font-weight: bold; color: #546e7a; text-align: center; transition: 0.1s; }
        .lvl-btn.active { border-color: var(--primary); background: #e3f2fd; color: var(--primary); transform: scale(1.05); }
        
        .category-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .cat-btn { background: white; border: 1px solid #b3e5fc; border-radius: 15px; padding: 15px; cursor: pointer; display: flex; flex-direction: column; align-items: center; position: relative; }
        .cat-name { font-weight: bold; font-size: 0.9rem; color: #01579b; }
        .badge { position: absolute; top: -5px; right: -5px; background: var(--wrong); color: white; border-radius: 10px; padding: 2px 6px; font-size: 0.6rem; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        
        #game-screen { display: none; width: 100%; flex-direction: column; align-items: center; max-width: 600px; }
        .word-card { background: #fff; width: 92%; border-radius: 20px; padding: 40px 10px; margin-top: 20px; box-shadow: 0 8px 25px rgba(0,0,0,0.08); text-align: center; position: relative; }
        .hint-zh { font-size: 1.4rem; color: #37474f; margin-bottom: 25px; font-weight: bold; }
        .spell-zone { font-family: 'Courier New', monospace; font-size: 2.6rem; color: #263238; min-height: 60px; display: flex; justify-content: center; flex-wrap: wrap; gap: 6px; }
        .letter { border-bottom: 3px solid #cfd8dc; min-width: 32px; display: inline-block; position: relative; height: 50px; line-height: 50px; }
        .letter.pre { border-bottom: none; color: #b0bec5; } 
        .letter.active { border-bottom-color: var(--primary); }
        .letter.active::after { content: ""; position: absolute; left: 50%; bottom: -3px; width: 100%; height: 3px; background: var(--primary); transform: translateX(-50%); animation: blink 1s infinite; }
        .letter.ok { border-bottom-color: var(--correct); color: var(--correct); font-weight: bold; }
        .letter.err { border-bottom-color: var(--wrong); color: var(--wrong); animation: shake 0.3s; }
        .letter.h-show { color: var(--warning); opacity: 0.5; font-weight: bold; } 
        @keyframes shake { 0%,100%{transform:translateX(0);} 25%{transform:translateX(-5px);} 75%{transform:translateX(5px);} }
        .streak-hint { font-size: 0.85rem; color: var(--warning); font-weight: bold; margin-bottom: 15px; display: block; background: #fff3e0; padding: 5px 10px; border-radius: 20px; }
        
        /* ç‰ˆæƒæ°´å°æ ·å¼ */
        .copyright-footer { position: fixed; bottom: 0; width: 100%; text-align: center; padding: 10px 0; background: rgba(255,255,255,0.8); font-size: 0.7rem; color: #90a4ae; border-top: 1px solid #e1f5fe; z-index: 2000; letter-spacing: 1px; }
        
        #hidden-input { position: absolute; opacity: 0; pointer-events: none; top: -100px; }
        #modal, #print-modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 25px; border-radius: 24px; box-shadow: 0 20px 60px rgba(0,0,0,0.4); text-align: center; z-index: 3000; width: 85%; max-width: 420px; }
        .btn-ui { background: var(--primary); color: white; border: none; padding: 14px; border-radius: 30px; cursor: pointer; margin-top: 10px; width: 100%; font-size: 1rem; font-weight: bold; }
        #print-content { text-align: left; max-height: 400px; overflow-y: auto; margin: 15px 0; font-size: 0.85rem; }
        .print-row { border-bottom: 1px dashed #ddd; padding: 10px 0; display: flex; justify-content: space-between; }
        @media print { body * { visibility: hidden; } #print-area, #print-area * { visibility: visible; } #print-area { position: absolute; left: 0; top: 0; width: 100%; background: white; } }
    </style>
</head>
<body onclick="focusInput()">
<div class="eye-care">ğŸ‘€ åå§¿æé†’ï¼šæŒºç›´èƒŒéƒ¨ã€‚å¬éŸ³å†™è¯ï¼Œåˆ†å±‚è®¡åˆ†ï¼</div>
<header>5A è‹±è¯­å¬å†™é€šå…³ç‹ V51</header>

<div id="menu-screen">
    <div class="progress-box">
        <div class="p-row" style="color:var(--lvl1)"><span>ğŸŸ¢ åˆçº§è¿›åº¦</span><div class="p-bar-bg"><div id="bar-1" class="p-fill" style="background:var(--lvl1)"></div></div><b id="txt-1">0/167</b></div>
        <div class="p-row" style="color:var(--lvl2)"><span>ğŸŸ  ä¸­çº§è¿›åº¦</span><div class="p-bar-bg"><div id="bar-2" class="p-fill" style="background:var(--lvl2)"></div></div><b id="txt-2">0/167</b></div>
        <div class="p-row" style="color:var(--lvl3)"><span>ğŸŸ£ é«˜çº§è¿›åº¦</span><div class="p-bar-bg"><div id="bar-3" class="p-fill" style="background:var(--lvl3)"></div></div><b id="txt-3">0/167</b></div>
        <button class="btn-ui" style="background: #607d8b; padding: 8px; font-size: 0.8rem;" onclick="showPrintModal()">ğŸ“‹ æ‰“å°é”™é¢˜æ¸…å•</button>
    </div>
    <div class="lvl-selector">
        <div class="lvl-btn active" id="btn-lvl-1" onclick="changeLvl(1, event)">åˆçº§æ¨¡å¼</div>
        <div class="lvl-btn" id="btn-lvl-2" onclick="changeLvl(2, event)">ä¸­çº§æ¨¡å¼</div>
        <div class="lvl-btn" id="btn-lvl-3" onclick="changeLvl(3, event)">é«˜çº§æ¨¡å¼</div>
    </div>
    <div class="category-grid" id="category-btns"></div>
</div>

<div id="game-screen">
    <div class="word-card">
        <div id="streak-text" class="streak-hint" style="display:none;"></div>
        <div class="hint-zh" id="hint-text">è½½å…¥ä¸­...</div>
        <div class="spell-zone" id="spell-area"></div>
        <div style="margin-top: 30px;"><button class="btn-ui" style="width: auto; padding: 10px 25px; background: #81d4fa;" onclick="speakNow(event)">ğŸ”ˆ é‡å¬è¯»éŸ³</button></div>
        <input type="text" id="hidden-input" autocomplete="off">
    </div>
    <button class="btn-ui" style="background:#94a3b8; width:90%; margin-top:40px;" onclick="showMenu()">è¿”å›ä¸»ç›®å½•</button>
</div>

<div class="copyright-footer">Copyright Â© ç‰ˆæƒå½’lukaæ‰€æœ‰</div>

<div id="print-modal">
    <h3>ğŸ“• åˆ†ç±»å¼ºåŒ–å¤ä¹ æ¸…å•</h3>
    <div id="print-content"></div>
    <div style="display:flex; gap:10px;">
        <button class="btn-ui" style="background:var(--correct)" onclick="window.print()">ğŸ–¨ï¸ æ‰“å°</button>
        <button class="btn-ui" style="background:#94a3b8" onclick="closePrint()">å…³é—­</button>
    </div>
</div>

<div id="modal">
    <h3 id="modal-title">ğŸŠ æŒ‘æˆ˜æˆåŠŸï¼</h3>
    <div id="report-html" style="margin:15px 0; font-size:1rem; color:#546e7a; line-height:1.5;"></div>
    <div style="font-size:0.6rem; color:#ccc; margin-bottom:10px;">å¼€å‘è€…ï¼šluka</div>
    <button class="btn-ui" id="btn-m-next" onclick="initLevel()">ç»§ç»­æŒ‘æˆ˜</button>
    <button class="btn-ui" style="background:#94a3b8" onclick="showMenu()">è¿”å›ç›®å½•</button>
</div>
<div id="print-area" style="display:none; padding:20px;"></div>

<script>
/**
 * æ ¸å¿ƒé€»è¾‘ç”± luka ç ”å‘
 * åŒ…å«ï¼š Phonics éŸ³èŠ‚åˆ‡åˆ†ã€ä¸‰çº§ç‹¬ç«‹ç»Ÿè®¡ã€é”™é¢˜å³æ—¶ç´¯è®¡ç­‰åŠŸèƒ½
 */
let audioCtx = null;
const playSFX = (type) => {
    try { if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); if (audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); osc.connect(gain); gain.connect(audioCtx.destination);
        if (type === 'ok') { osc.type = 'sine'; osc.frequency.setValueAtTime(880, audioCtx.currentTime); gain.gain.setValueAtTime(0.05, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.15); } 
        else if (type === 'err') { osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, audioCtx.currentTime); gain.gain.setValueAtTime(0.05, audioCtx.currentTime); gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.2); } 
        else { osc.type = 'triangle'; osc.frequency.setValueAtTime(440, audioCtx.currentTime); osc.frequency.linearRampToValueAtTime(880, audioCtx.currentTime + 0.2); gain.gain.setValueAtTime(0.05, audioCtx.currentTime); }
        osc.start(); osc.stop(audioCtx.currentTime + 0.2);
    } catch(e) {}
};

const dbWords = [
    ["ice cream","å†°æ¿€å‡Œ","é¥®é£Ÿ"],["rice","ç±³é¥­","é¥®é£Ÿ"],["dumpling","é¥ºå­","é¥®é£Ÿ"],["noodle","é¢æ¡","é¥®é£Ÿ"],["bread","é¢åŒ…","é¥®é£Ÿ"],["sandwich","ä¸‰æ˜æ²»","é¥®é£Ÿ"],["hamburger","æ±‰å ¡åŒ…","é¥®é£Ÿ"],["chips","ç‚¸è–¯æ¡","é¥®é£Ÿ"],["starter","ç¬¬ä¸€é“èœ","é¥®é£Ÿ"],["tomato","è¥¿çº¢æŸ¿","é¥®é£Ÿ"],["egg","é¸¡è›‹","é¥®é£Ÿ"],["soup","æ±¤","é¥®é£Ÿ"],["main course","ä¸»èœ","é¥®é£Ÿ"],["meat","è‚‰","é¥®é£Ÿ"],["vegetable","è”¬èœ","é¥®é£Ÿ"],["potato","é©¬é“ƒè–¯","é¥®é£Ÿ"],["dessert","ç”œå“","é¥®é£Ÿ"],["chocolate","å·§å…‹åŠ›","é¥®é£Ÿ"],["dimsum","ç‚¹å¿ƒ","é¥®é£Ÿ"],["pancake","è–„é¥¼","é¥®é£Ÿ"],["bun","é¦’å¤´","é¥®é£Ÿ"],["salad","è‰²æ‹‰","é¥®é£Ÿ"],["steak","ç‰›æ’","é¥®é£Ÿ"],
    ["coffee","å’–å•¡","é¥®å…·"],["tea","èŒ¶","é¥®å…·"],["milk","ç‰›å¥¶","é¥®å…·"],["coke","å¯ä¹","é¥®å…·"],["juice","æœæ±","é¥®å…·"],["drink","é¥®æ–™","é¥®å…·"],["cup","æ¯å­","é¥®å…·"],["bottle","ç“¶å­","é¥®å…·"],["glass","ç»ç’ƒæ¯","é¥®å…·"],["can","ç½å­","é¥®å…·"],["chopstick","ç­·å­","é¥®å…·"],["bowl","ç¢—","é¥®å…·"],["plate","ç›˜å­","é¥®å…·"],["knife","åˆ€","é¥®å…·"],["fork","å‰å­","é¥®å…·"],
    ["weekday","å·¥ä½œæ—¥","æ—¶ç©º"],["weekend","å‘¨æœ«","æ—¶ç©º"],["some day","æŸå¤©","æ—¶ç©º"],["season","å­£èŠ‚","æ—¶ç©º"],["lunchtime","åˆé¤æ—¶","æ—¶ç©º"],["p.m.","ä¸‹åˆ","æ—¶ç©º"],["life","ç”Ÿæ´»","æ—¶ç©º"],["country","å›½å®¶","æ—¶ç©º"],["place","åœ°æ–¹","æ—¶ç©º"],["market","å¸‚åœº","æ—¶ç©º"],["palace","å®«æ®¿","æ—¶ç©º"],["Childrenâ€™s Palace","å°‘å¹´å®«","æ—¶ç©º"],["cinema","ç”µå½±é™¢","æ—¶ç©º"],["England","è‹±å›½","æ—¶ç©º"],
    ["sky","å¤©ç©º","è‡ªç„¶"],["animal","åŠ¨ç‰©","è‡ªç„¶"],["weather","å¤©æ°”","è‡ªç„¶"],["cloud","äº‘","è‡ªç„¶"],["cloudy","å¤šäº‘","è‡ªç„¶"],["rain","é›¨","è‡ªç„¶"],["rainy","ä¸‹é›¨","è‡ªç„¶"],["wet","æ¹¿çš„","è‡ªç„¶"],["dry","å¹²çš„","è‡ªç„¶"],["sun","å¤ªé˜³","è‡ªç„¶"],["sunny","æ™´æœ—","è‡ªç„¶"],["warm","æ¸©æš–","è‡ªç„¶"],["cool","å‡‰çˆ½","è‡ªç„¶"],["snow","é›ª","è‡ªç„¶"],["snowy","é›ªå¤©","è‡ªç„¶"],["snowman","é›ªäºº","è‡ªç„¶"],["temperature","æ¸©åº¦","è‡ªç„¶"],["degree","åº¦","è‡ªç„¶"],["wind","é£","è‡ªç„¶"],["windy","æœ‰é£","è‡ªç„¶"],
    ["hobby","çˆ±å¥½","æè¿°"],["model","æ¨¡å‹","æè¿°"],["collect","æ”¶é›†","æè¿°"],["stamp","é‚®ç¥¨","æè¿°"],["drawing","ç”»","æè¿°"],["ability","èƒ½åŠ›","æè¿°"],["coloured","å½©è‰²çš„","æè¿°"],["different","ä¸åŒ","æè¿°"],["fresh","æ–°é²œ","æè¿°"],["healthy","å¥åº·","æè¿°"],["hungry","é¥¿çš„","æè¿°"],["delicious","ç¾å‘³","æè¿°"],["terrible","ç³Ÿç³•","æè¿°"],["true","çœŸå®","æè¿°"],["umbrella","é›¨ä¼","æè¿°"],
    ["talk","è°ˆè¯","åŠ¨ä½œ"],["speak","è¯´","åŠ¨ä½œ"],["say","è¯´","åŠ¨ä½œ"],["ask","é—®","åŠ¨ä½œ"],["smell","é—»","åŠ¨ä½œ"],["taste","å°","åŠ¨ä½œ"],["keep","ä¿æŒ","åŠ¨ä½œ"],["count","æ•°æ•°","åŠ¨ä½œ"],["find","æ‰¾åˆ°","åŠ¨ä½œ"],["look for","å¯»æ‰¾","åŠ¨ä½œ"],["wake up","é†’æ¥","åŠ¨ä½œ"],["stay","åœç•™","åŠ¨ä½œ"],["wait","ç­‰å¾…","åŠ¨ä½œ"],["put on","ç©¿ä¸Š","åŠ¨ä½œ"],["change","æ”¹å˜","åŠ¨ä½œ"],["turn","è½¬","åŠ¨ä½œ"],["shine","ç…§è€€","åŠ¨ä½œ"],["walk","èµ°è·¯","åŠ¨ä½œ"],
    ["said","è¯´(è¿‡)","è¿‡å»"],["went","å»(è¿‡)","è¿‡å»"],["had","æœ‰(è¿‡)","è¿‡å»"],["thought","æƒ³(è¿‡)","è¿‡å»"],
    ["more than","å¤šäº","å¸¸ç”¨"],["plenty of","å¤§é‡","å¸¸ç”¨"],["for example","ä¾‹å¦‚","å¸¸ç”¨"],["a cup of","ä¸€æ¯","å¸¸ç”¨"],["a bottle of","ä¸€ç“¶","å¸¸ç”¨"],["seldom","æå°‘","å¸¸ç”¨"],["often","ç»å¸¸","å¸¸ç”¨"],["usually","é€šå¸¸","å¸¸ç”¨"],["quite","ç›¸å½“","å¸¸ç”¨"],["maybe","å¯èƒ½","å¸¸ç”¨"],["together","ä¸€èµ·","å¸¸ç”¨"],["have fun","å¨±ä¹","å¸¸ç”¨"],
    ["than","æ¯”","å…¶ä»–"],["more","æ›´å¤š","å…¶ä»–"],["every","æ¯","å…¶ä»–"],["during","æœŸé—´","å…¶ä»–"],["Mrs","å¤ªå¤ª","å…¶ä»–"],["son","å„¿å­","å…¶ä»–"],["everyone","æ‰€æœ‰äºº","å…¶ä»–"],["something","æŸç‰©","å…¶ä»–"],["yours","ä½ çš„","å…¶ä»–"],["example","ä¾‹å­","å…¶ä»–"],["report","æŠ¥å‘Š","å…¶ä»–"],["both","ä¸¤è€…éƒ½","å…¶ä»–"],["should","åº”è¯¥","å…¶ä»–"],["shouldn't","ä¸åº”è¯¥","å…¶ä»–"],["hope","å¸Œæœ›","å…¶ä»–"],["need","éœ€è¦","å…¶ä»–"],["come on","æ¥å§","å…¶ä»–"],["first","ç¬¬ä¸€","å…¶ä»–"],["sweet","ç”œ","å…¶ä»–"],["salty","å’¸","å…¶ä»–"],["sour","é…¸","å…¶ä»–"],["western","è¥¿æ–¹","å…¶ä»–"],["most","å¤šæ•°","å…¶ä»–"],["also","ä¹Ÿ","å…¶ä»–"],["again","å†ä¸€æ¬¡","å…¶ä»–"],["warm","æ¸©æš–","å…¶ä»–"],["cool","å‡‰çˆ½","å…¶ä»–"],["cold","å†·","å…¶ä»–"],["hot","çƒ­","å…¶ä»–"],["busy","å¿™","å…¶ä»–"],["far","è¿œ","å…¶ä»–"],["sure","ç¡®ä¿¡","å…¶ä»–"],["dear","äº²çˆ±","å…¶ä»–"],["early","æ—©","å…¶ä»–"],["quickly","è¿…é€Ÿ","å…¶ä»–"],["away","ç¦»å¼€","å…¶ä»–"],["outside","å¤–é¢","å…¶ä»–"],["hard","åŠªåŠ›","å…¶ä»–"],["before","ä¹‹å‰","å…¶ä»–"],["start","å¼€å§‹","å…¶ä»–"],["finish","å®Œæˆ","å…¶ä»–"],["talking","ä¼šè¯´","å…¶ä»–"],["uh","å””","å…¶ä»–"]
];

let stats = JSON.parse(localStorage.getItem('5A_SP_V51')) || {lvl1:{}, lvl2:{}, lvl3:{}};
let curLvl = 1, curCat = "", wordIdx = 0, currentWord = "", typed = "", lock = false;
let sessionPool = [], maskList = [], errorCount = 0, hintUsed = false;

function changeLvl(l, e) { if(e) e.stopPropagation(); curLvl = l; document.querySelectorAll('.lvl-btn').forEach(b => b.classList.toggle('active', b.id === 'btn-lvl-'+l)); showMenu(); }
function focusInput() { if(!lock) document.getElementById('hidden-input').focus(); }
function splitSyl(w) { return w.match(/[^aeiouy]*[aeiouy]+(?:[^aeiouy](?![aeiouy]))*/gi) || [w]; }

function showMenu() {
    document.getElementById('menu-screen').style.display='block'; document.getElementById('game-screen').style.display='none'; document.getElementById('modal').style.display='none';
    const lk = 'lvl' + curLvl; lock = false;
    for(let l=1; l<=3; l++) {
        let mCount = dbWords.filter(i => stats['lvl'+l][i[0]]?.m).length;
        document.getElementById('bar-'+l).style.width = (mCount / dbWords.length * 100) + '%';
        document.getElementById('txt-'+l).innerText = mCount + ' / ' + dbWords.length;
    }
    const grid = document.getElementById('category-btns'); grid.innerHTML = '';
    let mistakes = dbWords.filter(i => { let s = stats[lk][i[0]]; return s && !s.m && (s.e || []).length > 0; });
    if(mistakes.length > 0) {
        let btn = document.createElement('div'); btn.className = 'cat-btn'; btn.style.borderColor = 'var(--wrong)'; btn.style.background = '#fff5f5';
        btn.innerHTML = `<span class="cat-name" style="color:var(--wrong)">ğŸ“• ä¸“å±é”™é¢˜æœ¬</span><span class="cat-info">${mistakes.length}è¯å¾…æŒæ¡</span><div class="badge">${mistakes.length}</div>`;
        btn.onclick = (ev) => { ev.stopPropagation(); curCat = "é”™é¢˜"; initLevel(); }; grid.appendChild(btn);
    }
    [...new Set(dbWords.map(i => i[2]))].forEach(c => {
        let list = dbWords.filter(i => i[2] === c);
        let mCount = list.filter(i => stats[lk][i[0]]?.m).length;
        let btn = document.createElement('div'); btn.className = 'cat-btn';
        btn.innerHTML = `<span class="cat-name">${c}</span><span class="cat-info">${mCount}/${list.length}</span>`;
        btn.onclick = (ev) => { ev.stopPropagation(); curCat = c; initLevel(); }; grid.appendChild(btn);
    });
}

function initLevel() {
    document.getElementById('modal').style.display='none'; document.getElementById('menu-screen').style.display='none'; document.getElementById('game-screen').style.display='flex';
    const lk = 'lvl' + curLvl; lock = false;
    let pool = [];
    if(curCat === "é”™é¢˜") {
        pool = dbWords.filter(i => stats[lk][i[0]] && !stats[lk][i[0]].m && stats[lk][i[0]].e.length > 0);
    } else {
        pool = dbWords.filter(i => i[2] === curCat && !stats[lk][i[0]]?.m && (!stats[lk][i[0]] || stats[lk][i[0]].e.length === 0));
        if(pool.length === 0) pool = dbWords.filter(i => i[2] === curCat);
    }
    pool.sort(() => Math.random() - 0.5); sessionPool = pool.slice(0, 10); wordIdx = 0; startNext();
}

function startNext() {
    if (wordIdx >= sessionPool.length) { finish(); return; }
    currentWord = sessionPool[wordIdx][0].toLowerCase();
    document.getElementById('hint-text').innerText = sessionPool[wordIdx][1];
    typed = ""; errorCount = 0; hintUsed = false;
    const lk = 'lvl' + curLvl; const s = stats[lk][currentWord];
    const sHint = document.getElementById('streak-text');
    if(curCat === "é”™é¢˜" && s) { sHint.style.display = 'block'; sHint.innerText = `ğŸ¯ è¯¥è¯ç´¯è®¡æ‹¼å¯¹è¿›åº¦: ${s.s}/5`; } else { sHint.style.display = 'none'; }
    maskList = new Array(currentWord.length).fill(true); const syls = splitSyl(currentWord);
    if(curLvl === 1) {
        if(syls.length > 1) { let hIdx = Math.floor(Math.random() * syls.length); let cIdx = 0; syls.forEach((s, idx) => { for(let c of s) { maskList[cIdx] = (idx === hIdx); cIdx++; } }); } 
        else { for(let i=0; i<currentWord.length; i++) if(i === 0 || i === currentWord.length - 1) maskList[i] = false; }
    } else if(curLvl === 2) {
        if(syls.length > 1) { let sIdx = Math.floor(Math.random() * syls.length); let cIdx = 0; syls.forEach((s, idx) => { for(let c of s) { maskList[cIdx] = (idx !== sIdx); cIdx++; } }); } 
        else { maskList[0] = false; }
    }
    autoCheck(); renderArea(); setTimeout(() => { speakNow(); focusInput(); }, 300);
}

function autoCheck() { while(typed.length < currentWord.length && !/[a-z]/.test(currentWord[typed.length])) { typed += currentWord[typed.length]; } }

function renderArea() {
    const area = document.getElementById('spell-area'); area.innerHTML = '';
    for(let i=0; i < currentWord.length; i++) {
        const char = currentWord[i]; if(char === " ") { area.innerHTML += '<span style="width:20px"></span>'; continue; }
        let state = "", disp = "&nbsp;";
        if (i < typed.length) { state = "ok"; disp = char; } 
        else if (i === typed.length) { state = "active"; disp = (errorCount >= 3) ? char : "&nbsp;"; } 
        else { if (!maskList[i]) { state = "pre"; disp = char; } else if (errorCount >= 3) { state = "h-show"; disp = char; } }
        area.innerHTML += `<span class="letter ${state}">${disp}</span>`;
    }
}

document.getElementById('hidden-input').oninput = (e) => {
    if(lock) return;
    let val = e.target.value.toLowerCase(); e.target.value = "";
    if(val) {
        let key = val[val.length-1];
        if(key === currentWord[typed.length]){
            typed += key; playSFX('ok'); autoCheck();
            if(typed === currentWord){
                const res = updateWordStat(currentWord, !hintUsed && errorCount === 0);
                lock = true; 
                if(res === "DONE") {
                    document.getElementById('modal-title').innerText = "âœ¨ å½»åº•æŒæ¡ï¼";
                    document.getElementById('report-html').innerHTML = `<b style="color:var(--correct)">"${currentWord}"</b> å·²ç´¯è®¡æ‹¼å¯¹ 5 æ¬¡ï¼<br>æˆåŠŸç§»å‡ºé”™é¢˜æœ¬ã€‚`;
                    document.getElementById('modal').style.display='block';
                } else {
                    if(curCat === "é”™é¢˜") { const s = stats['lvl'+curLvl][currentWord]; document.getElementById('streak-text').innerText = `ğŸ¯ ç´¯è®¡æ‹¼å¯¹è¿›åº¦: ${s.s}/5`; }
                    setTimeout(()=>{ lock=false; wordIdx++; startNext(); }, 600);
                }
            }
        } else {
            errorCount++; playSFX('err'); if(errorCount === 3) { hintUsed = true; playSFX('hint'); }
            renderArea(); const letters = document.querySelectorAll('.letter');
            if(letters[typed.length]) { letters[typed.length].classList.add('err'); setTimeout(()=> { if(letters[typed.length]) letters[typed.length].classList.remove('err'); }, 400); }
        }
        renderArea();
    }
};

function updateWordStat(w, perfect){
    let lk = 'lvl' + curLvl; let status = "CONTINUE";
    if(!stats[lk][w]) stats[lk][w] = {m:false, s:0, e:[]};
    if(perfect){ 
        if((stats[lk][w].e || []).length === 0) { stats[lk][w].m = true; } 
        else { stats[lk][w].s++; if(stats[lk][w].s >= 5) { stats[lk][w].m = true; status = "DONE"; } }
    } else { 
        stats[lk][w].m = false; stats[lk][w].s = 0; if(!stats[lk][w].e) stats[lk][w].e = []; stats[lk][w].e.push(Date.now()); 
    }
    localStorage.setItem('5A_SP_V51', JSON.stringify(stats)); return status;
}

function showPrintModal() {
    const lk = 'lvl' + curLvl;
    const allBad = dbWords.filter(i => { let s = stats[lk][i[0]]; return s && (s.e || []).length > 0; });
    const content = document.getElementById('print-content'); content.innerHTML = "";
    const pArea = document.getElementById('print-area'); pArea.innerHTML = `<h2>5Aè‹±è¯­ [${curLvl==1?'åˆçº§':curLvl==2?'ä¸­çº§':'é«˜çº§'}] å¼ºåŒ–å¤ä¹ æ¸…å•</h2>`;
    if(allBad.length === 0) { content.innerHTML = "å½“å‰éš¾åº¦æš‚æ— è®°å½•ã€‚"; }
    else {
        [...new Set(allBad.map(i => i[2]))].forEach(catName => {
            content.innerHTML += `<h4 style="margin:10px 0 5px; color:var(--primary)">${catName}</h4>`;
            pArea.innerHTML += `<h3 style="border-bottom:2px solid #000">${catName}</h3>`;
            allBad.filter(i => i[2] === catName).forEach(m => {
                let s = stats[lk][m[0]];
                let row = `<div class="print-row"><span><b>${m[0]}</b> [${m[1]}]</span><span>å†å²é”™${s.e.length}æ¬¡ / ç´¯è®¡å¯¹${s.s} ${s.m?'(å·²é€šè¿‡)':'(æœªæŒæ¡)'}</span></div>`;
                content.innerHTML += row; pArea.innerHTML += row;
            });
        });
    }
    document.getElementById('print-modal').style.display='block';
}
function closePrint() { document.getElementById('print-modal').style.display='none'; }
function speakNow(e) { if(e) e.stopPropagation(); window.speechSynthesis.cancel(); let m=new SpeechSynthesisUtterance(currentWord); m.lang='en-US'; m.rate=0.7; window.speechSynthesis.speak(m); focusInput(); }
window.onkeydown = (e) => { if(e.key==='Backspace' && !lock){ typed = typed.slice(0,-1); while(typed.length>0 && !/[a-z]/.test(currentWord[typed.length-1])) typed = typed.slice(0,-1); renderArea(); } };
function finish() { document.getElementById('modal-title').innerText = "ğŸŠ è½®æ¬¡å®Œæˆï¼"; document.getElementById('report-html').innerHTML = "æœ¬ç»„ç»ƒä¹ å®Œæ¯•ã€‚æ‰€æœ‰è¿›åº¦å·²å®æ—¶åŒæ­¥ï¼<br><span style='font-size:0.8rem;'>Copyright Â© luka</span>"; document.getElementById('modal').style.display='block'; }
showMenu();
</script>
</body><div style="text-align:center; margin: 20px 0;">
  <a href=" " style="text-decoration:none; background:#673ab7; color:#fff; padding:10px 20px; border-radius:12px; font-weight:bold; box-shadow:0 4px 10px rgba(0,0,0,0.1);">ğŸ  è¿”å›å¤§æœ¬è¥ä¸»é¡µ</a >
</div>
</html>